<!DOCTYPE html>
<html>
<head>
<style>
body {
  background-color: darkgrey;
}

canvas {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

</style>
</head>

<body>
<div>
<canvas id="canvas1" width=640 height=480 class="canvas"></canvas>
<canvas id="canvas2" width=640 height=480 class="canvas"></canvas>
</div>

<script>

    let angle = 2 * Math.PI / 1480;

    var bl = {x:-1, y:-1, z:5}
    var br = {x:1, y:-1, z:5}
    var tl = {x:-1, y:1, z:5}
    var tr = {x:1, y:1, z:5}

    var blz = {x:-1, y:-1, z:7}
    var brz = {x:1, y:-1, z:7}
    var tlz = {x:-1, y:1, z:7}
    var trz = {x:1, y:1, z:7}

function worldToScreen(p) {
    let factor = 640
    let screen = {x: p.x / p.z * factor + 320, y: p.y / p.z * factor + 240}
    return screen
}

function rotateZ(p) {
  return {x: p.x*Math.cos(angle) - p.y*Math.sin(angle), y:p.y*Math.cos(angle) + p.x*Math.sin(angle), z: p.z}
}

function rotateX(p) {
    let z = p.z - 6
    let y = p.y*Math.cos(angle) - z*Math.sin(angle)
    let zz = (p.y*Math.sin(angle) + z*Math.cos(angle)) + 6
    return {x: p.x, y: y, z: zz}
}

function rotateY(p) {
    let z = p.z - 6
    let x = p.x*Math.cos(angle) + z*Math.sin(angle)
    let zz = (-p.x*Math.sin(angle) + z*Math.cos(angle)) + 6
    return {x: x, y: p.y, z: zz}
}

function drawPixel(point) {
     context.fillStyle = "#222"
     context.fillRect(point.x, point.y, 1, 1)
   }


function drawLine(p0, p1) {
    context.beginPath();
    context.moveTo(p0.x, p0.y);
    context.lineTo(p1.x, p1.y);
    context.lineWidth = "2"
    context.strokeStyle = "#222";
    context.stroke();
}

   function update() {
    context.fillStyle = "darkgrey";
    context.fillRect(0, 0, 640, 480);
     
    bl = rotateZ(bl)
    br = rotateZ(br)
    tl = rotateZ(tl)
    tr = rotateZ(tr)
    blz = rotateZ(blz)
    brz = rotateZ(brz)
    tlz = rotateZ(tlz)
    trz = rotateZ(trz)

    bl = rotateY(bl)
    br = rotateY(br)
    tl = rotateY(tl)
    tr = rotateY(tr)
    blz = rotateY(blz)
    brz = rotateY(brz)
    tlz = rotateY(tlz)
    trz = rotateY(trz)

    // bl = rotateX(bl)
    // br = rotateX(br)
    // tl = rotateX(tl)
    // tr = rotateX(tr)
    // blz = rotateX(blz)
    // brz = rotateX(brz)
    // tlz = rotateX(tlz)
    // trz = rotateX(trz)

    var blr = worldToScreen(bl)
    var brr = worldToScreen(br)
    var tlr = worldToScreen(tl)
    var trr = worldToScreen(tr)

    var blrz = worldToScreen(blz)
    var brrz = worldToScreen(brz)
    var tlrz = worldToScreen(tlz)
    var trrz = worldToScreen(trz)
    
    let face1z = (bl.z + br.z + tr.z + tl.z) / 4;
    let face2z = (blz.z + brz.z + trz.z + tlz.z) / 4;  
    let face3z = (bl.z + tl.z + tlz.z + blz.z) / 4;
    let face4z = (br.z + tr.z + trz.z + brz.z) / 4;
    let face5z = (tl.z + tr.z + trz.z + tlz.z) / 4;
    let face6z = (bl.z + br.z + brz.z + blz.z) / 4;

    let front = {p1: blr, p2: brr, p3: trr, p4: tlr, color: "#FF0000", z: face1z};
    let back = {p1: blrz, p2: brrz, p3: trrz, p4: tlrz, color: "#00FF00", z: face2z};
    let left = {p1: blr, p2: tlr, p3: tlrz, p4: blrz, color: "#0000FF", z: face3z};  
    let right = {p1: brr, p2: trr, p3: trrz, p4: brrz, color: "#00FFFF", z: face4z};
    let top = {p1: tlr, p2: trr, p3: trrz, p4: tlrz, color: "#FF00FF", z: face5z};
    let bottom = {p1: blr, p2: brr, p3: brrz, p4: blrz, color: "#FFFF00", z: face6z};

    var faces = [front, back, left, right, top, bottom];
    faces.sort(zSort);
    faces.forEach(drawFace);
    
    flip();
    requestAnimationFrame(update);
   } 

   function zSort(a, b) {
       let aZ = a.z;
       let bZ = b.z;

       if (aZ < bZ) { return 1; }
       if (aZ > bZ) { return -1; }

       return 0;
   }

   function drawFace(face) {

    let p1 = face.p1;
    let p2 = face.p2;
    let p3 = face.p3;
    let p4 = face.p4;

    var ctx = context;
    
    ctx.beginPath();
    ctx.moveTo(p1.x, p1.y);
    ctx.lineTo(p2.x, p2.y);
    ctx.lineTo(p3.x, p3.y);
    ctx.lineTo(p4.x, p4.y);
    ctx.closePath();
    ctx.stroke();
    context.fillStyle = face.color;
    ctx.fill();
   }

    var canvas  = document.getElementById("canvas2");
    var context = canvas.getContext("2d");

    var canvas1 = document.getElementById("canvas1");
    var canvas2 = document.getElementById("canvas2");

    canvas1.style.visibility = 'visible';
    canvas2.style.visibility = 'hidden';

    update()

    function flip() {
        if (canvas1.style.visibility === 'visible') {
            canvas1.style.visibility = 'hidden';
            canvas  = document.getElementById("canvas1");
            context = canvas.getContext("2d");
        } else if (canvas1.style.visibility === 'hidden') {
            canvas1.style.visibility = 'visible';
        }

        if (canvas2.style.visibility === 'visible') {
            canvas2.style.visibility = 'hidden';
            canvas  = document.getElementById("canvas2");
            context = canvas.getContext("2d");
        } else if (canvas2.style.visibility === 'hidden') {
            canvas2.style.visibility = 'visible';
        }       
    }
</script>

</body>
</html>
